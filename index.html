<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2487.7">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
  </style>
</head>
<body>
<p class="p1">&lt;!DOCTYPE html&gt;</p>
<p class="p1">&lt;html lang="en"&gt;</p>
<p class="p1">&lt;head&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;meta charset="UTF-8"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;title&gt;A Fantastical Birthday for Polly!&lt;/title&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;style&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>body {</p>
<p class="p1"><span class="Apple-converted-space">            </span>margin: 0;</p>
<p class="p1"><span class="Apple-converted-space">            </span>overflow: hidden;</p>
<p class="p1"><span class="Apple-converted-space">            </span>background: linear-gradient(45deg, #ff9a9e 0%, #fad0c4 99%, #fad0c4 100%); /* Playful gradient */</p>
<p class="p1"><span class="Apple-converted-space">            </span>display: flex;</p>
<p class="p1"><span class="Apple-converted-space">            </span>justify-content: center;</p>
<p class="p1"><span class="Apple-converted-space">            </span>align-items: center;</p>
<p class="p1"><span class="Apple-converted-space">            </span>height: 100vh;</p>
<p class="p1"><span class="Apple-converted-space">            </span>font-family: 'Comic Sans MS', 'Chalkboard SE', 'Marker Felt', fantasy; /* Whimsical font */</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>#scene-container {</p>
<p class="p1"><span class="Apple-converted-space">            </span>width: 90vw; /* Responsive width */</p>
<p class="p1"><span class="Apple-converted-space">            </span>height: 90vh; /* Responsive height */</p>
<p class="p1"><span class="Apple-converted-space">            </span>max-width: 1000px; /* Max size */</p>
<p class="p1"><span class="Apple-converted-space">            </span>max-height: 700px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>position: relative; /* For absolute positioning of overlays */</p>
<p class="p1"><span class="Apple-converted-space">            </span>box-shadow: 0 0 30px rgba(0,0,0,0.2);</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-radius: 20px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: #1a001a; /* Dark, magical backdrop for 3D scene */</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>#threejs-canvas {</p>
<p class="p1"><span class="Apple-converted-space">            </span>display: block;</p>
<p class="p1"><span class="Apple-converted-space">            </span>width: 100%;</p>
<p class="p1"><span class="Apple-converted-space">            </span>height: 100%;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-radius: 20px;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>/* UI Elements */</p>
<p class="p1"><span class="Apple-converted-space">        </span>.birthday-title {</p>
<p class="p1"><span class="Apple-converted-space">            </span>position: absolute;</p>
<p class="p1"><span class="Apple-converted-space">            </span>top: 20px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>left: 50%;</p>
<p class="p1"><span class="Apple-converted-space">            </span>transform: translateX(-50%);</p>
<p class="p1"><span class="Apple-converted-space">            </span>color: #fff;</p>
<p class="p1"><span class="Apple-converted-space">            </span>font-size: 2.5em; /* Responsive font size would be better with vw/vh or media queries */</p>
<p class="p1"><span class="Apple-converted-space">            </span>text-shadow: 2px 2px 5px #ff00ff;</p>
<p class="p1"><span class="Apple-converted-space">            </span>z-index: 10;</p>
<p class="p1"><span class="Apple-converted-space">            </span>text-align: center;</p>
<p class="p1"><span class="Apple-converted-space">            </span>padding: 0 10px;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>.interactive-button {</p>
<p class="p1"><span class="Apple-converted-space">            </span>position: absolute;</p>
<p class="p1"><span class="Apple-converted-space">            </span>bottom: 30px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>padding: 12px 25px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>font-size: 1.2em;</p>
<p class="p1"><span class="Apple-converted-space">            </span>color: white;</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: #ff69b4; /* Hot pink */</p>
<p class="p1"><span class="Apple-converted-space">            </span>border: 3px solid #fff;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-radius: 50px; /* Fun, pillowy shape */</p>
<p class="p1"><span class="Apple-converted-space">            </span>cursor: pointer;</p>
<p class="p1"><span class="Apple-converted-space">            </span>box-shadow: 0 5px #c71585; /* MediumVioletRed */</p>
<p class="p1"><span class="Apple-converted-space">            </span>transition: all 0.1s ease-in-out;</p>
<p class="p1"><span class="Apple-converted-space">            </span>z-index: 10;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>.interactive-button:active {</p>
<p class="p1"><span class="Apple-converted-space">            </span>transform: translateY(3px);</p>
<p class="p1"><span class="Apple-converted-space">            </span>box-shadow: 0 2px #c71585;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>#blow-candles-button {</p>
<p class="p1"><span class="Apple-converted-space">            </span>left: 30%;</p>
<p class="p1"><span class="Apple-converted-space">            </span>transform: translateX(-50%);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>#launch-fireworks-button {</p>
<p class="p1"><span class="Apple-converted-space">            </span>right: 30%;</p>
<p class="p1"><span class="Apple-converted-space">            </span>transform: translateX(50%);</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: #ffd700; /* Gold */</p>
<p class="p1"><span class="Apple-converted-space">            </span>box-shadow: 0 5px #b8860b; /* DarkGoldenrod */</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">         </span>#launch-fireworks-button:active {</p>
<p class="p1"><span class="Apple-converted-space">            </span>box-shadow: 0 2px #b8860b;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>/* For Matter.js - if rendering to a separate canvas or DOM elements */</p>
<p class="p1"><span class="Apple-converted-space">        </span>#matter-container {</p>
<p class="p1"><span class="Apple-converted-space">            </span>position: absolute;</p>
<p class="p1"><span class="Apple-converted-space">            </span>top: 0;</p>
<p class="p1"><span class="Apple-converted-space">            </span>left: 0;</p>
<p class="p1"><span class="Apple-converted-space">            </span>width: 100%;</p>
<p class="p1"><span class="Apple-converted-space">            </span>height: 100%;</p>
<p class="p1"><span class="Apple-converted-space">            </span>pointer-events: none; /* Allow clicks to pass through to Three.js canvas unless interacting with Matter objects */</p>
<p class="p1"><span class="Apple-converted-space">            </span>z-index: 5; /* Below UI buttons, above Three.js if needed for visual layering */</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>.matter-object { /* Example style if you render Matter.js bodies as DOM elements */</p>
<p class="p1"><span class="Apple-converted-space">            </span>background-color: rgba(128,0,128,0.7); /* Purple, semi-transparent */</p>
<p class="p1"><span class="Apple-converted-space">            </span>border: 2px solid gold;</p>
<p class="p1"><span class="Apple-converted-space">            </span>border-radius: 5px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>display: flex;</p>
<p class="p1"><span class="Apple-converted-space">            </span>justify-content: center;</p>
<p class="p1"><span class="Apple-converted-space">            </span>align-items: center;</p>
<p class="p1"><span class="Apple-converted-space">            </span>color: white;</p>
<p class="p1"><span class="Apple-converted-space">            </span>font-size: 0.8em;</p>
<p class="p1"><span class="Apple-converted-space">            </span>text-align: center;</p>
<p class="p1"><span class="Apple-converted-space">            </span>padding: 5px;</p>
<p class="p1"><span class="Apple-converted-space">            </span>box-sizing: border-box;</p>
<p class="p1"><span class="Apple-converted-space">            </span>/* Matter.js will control position and size if tied to DOM elements */</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/style&gt;</p>
<p class="p1">&lt;/head&gt;</p>
<p class="p1">&lt;body&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="scene-container"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="birthday-title" id="main-title"&gt;🎉 Happy Birthday, Polly! 🎉&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;canvas id="threejs-canvas"&gt;&lt;/canvas&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div id="matter-container"&gt;&lt;/div&gt; &lt;button id="blow-candles-button" class="interactive-button"&gt;🌬️ Blow Out Candles!&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;button id="launch-fireworks-button" class="interactive-button"&gt;🎆 Launch Firework!&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"&gt;&lt;/script&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"&gt;&lt;/script&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"&gt;&lt;/script&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;script&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>// --- Global Variables ---</p>
<p class="p1"><span class="Apple-converted-space">        </span>let scene, camera, renderer;</p>
<p class="p1"><span class="Apple-converted-space">        </span>let cake, candles = [], flames = [], allCandlesLit = true;</p>
<p class="p1"><span class="Apple-converted-space">        </span>let matterEngine, matterWorld, matterRenderer; // Matter.js specific</p>
<p class="p1"><span class="Apple-converted-space">        </span>const interactiveObjects = []; // For Matter.js objects</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// DOM Elements</p>
<p class="p1"><span class="Apple-converted-space">        </span>const sceneContainer = document.getElementById('scene-container');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const threeCanvas = document.getElementById('threejs-canvas');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const mainTitle = document.getElementById('main-title');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const blowCandlesButton = document.getElementById('blow-candles-button');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const launchFireworksButton = document.getElementById('launch-fireworks-button');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const matterContainer = document.getElementById('matter-container');</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// --- Cheeky Helper Functions ---</p>
<p class="p1"><span class="Apple-converted-space">        </span>function randomCheekyColor() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const colors = [0xff69b4, 0xdda0dd, 0x87cefa, 0x32cd32, 0xffd700, 0xffa07a];</p>
<p class="p1"><span class="Apple-converted-space">            </span>return colors[Math.floor(Math.random() * colors.length)];</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// --- Three.js Setup ---</p>
<p class="p1"><span class="Apple-converted-space">        </span>function initThreeJS() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>scene = new THREE.Scene();</p>
<p class="p1"><span class="Apple-converted-space">            </span>// scene.fog = new THREE.Fog(0x1a001a, 20, 50); // Optional magical fog</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>camera = new THREE.PerspectiveCamera(75, sceneContainer.clientWidth / sceneContainer.clientHeight, 0.1, 1000);</p>
<p class="p1"><span class="Apple-converted-space">            </span>camera.position.set(0, 8, 18); // Adjusted camera position</p>
<p class="p1"><span class="Apple-converted-space">            </span>camera.lookAt(0, 3, 0);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>renderer = new THREE.WebGLRenderer({ canvas: threeCanvas, antialias: true, alpha: true }); // alpha for potential transparency over body bg</p>
<p class="p1"><span class="Apple-converted-space">            </span>renderer.setSize(sceneContainer.clientWidth, sceneContainer.clientHeight);</p>
<p class="p1"><span class="Apple-converted-space">            </span>renderer.setPixelRatio(window.devicePixelRatio);</p>
<p class="p1"><span class="Apple-converted-space">            </span>renderer.shadowMap.enabled = true;</p>
<p class="p1"><span class="Apple-converted-space">            </span>renderer.shadowMap.type = THREE.PCFSoftShadowMap;</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Lighting</p>
<p class="p1"><span class="Apple-converted-space">            </span>const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);</p>
<p class="p1"><span class="Apple-converted-space">            </span>scene.add(ambientLight);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const dirLight = new THREE.DirectionalLight(0xffffff, 1);</p>
<p class="p1"><span class="Apple-converted-space">            </span>dirLight.position.set(10, 15, 10);</p>
<p class="p1"><span class="Apple-converted-space">            </span>dirLight.castShadow = true;</p>
<p class="p1"><span class="Apple-converted-space">            </span>dirLight.shadow.mapSize.width = 1024;</p>
<p class="p1"><span class="Apple-converted-space">            </span>dirLight.shadow.mapSize.height = 1024;</p>
<p class="p1"><span class="Apple-converted-space">            </span>dirLight.shadow.camera.near = 0.5;</p>
<p class="p1"><span class="Apple-converted-space">            </span>dirLight.shadow.camera.far = 50;</p>
<p class="p1"><span class="Apple-converted-space">            </span>scene.add(dirLight);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>createCake();</p>
<p class="p1"><span class="Apple-converted-space">            </span>createCandlesOnCake(5); // Let's add 5 candles</p>
<p class="p1"><span class="Apple-converted-space">            </span>createGround(); // For shadows</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function createGround() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const groundGeo = new THREE.PlaneGeometry(50, 50);</p>
<p class="p1"><span class="Apple-converted-space">            </span>const groundMat = new THREE.ShadowMaterial({ opacity: 0.4 }); // Receives shadows</p>
<p class="p1"><span class="Apple-converted-space">            </span>const ground = new THREE.Mesh(groundGeo, groundMat);</p>
<p class="p1"><span class="Apple-converted-space">            </span>ground.rotation.x = -Math.PI / 2;</p>
<p class="p1"><span class="Apple-converted-space">            </span>ground.position.y = -0.05; // Slightly below the cake</p>
<p class="p1"><span class="Apple-converted-space">            </span>ground.receiveShadow = true;</p>
<p class="p1"><span class="Apple-converted-space">            </span>scene.add(ground);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function createCake() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const cakeGroup = new THREE.Group();</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Layers of the cake</p>
<p class="p1"><span class="Apple-converted-space">            </span>const mainLayerMat = new THREE.MeshPhongMaterial({ color: 0xdda0dd, shininess: 50 }); // Lavender</p>
<p class="p1"><span class="Apple-converted-space">            </span>const mainLayerGeo = new THREE.CylinderGeometry(4, 4.5, 2.5, 32); // Slightly tapered</p>
<p class="p1"><span class="Apple-converted-space">            </span>const mainLayer = new THREE.Mesh(mainLayerGeo, mainLayerMat);</p>
<p class="p1"><span class="Apple-converted-space">            </span>mainLayer.castShadow = true;</p>
<p class="p1"><span class="Apple-converted-space">            </span>mainLayer.receiveShadow = true;</p>
<p class="p1"><span class="Apple-converted-space">            </span>mainLayer.position.y = 1.25;</p>
<p class="p1"><span class="Apple-converted-space">            </span>cakeGroup.add(mainLayer);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const frostingMat = new THREE.MeshPhongMaterial({ color: 0x98fb98, shininess: 80 }); // PaleGreen / Mint</p>
<p class="p1"><span class="Apple-converted-space">            </span>const frostingGeo = new THREE.TorusGeometry(4.25, 0.5, 16, 100); // Frosting ring</p>
<p class="p1"><span class="Apple-converted-space">            </span>const frosting = new THREE.Mesh(frostingGeo, frostingMat);</p>
<p class="p1"><span class="Apple-converted-space">            </span>frosting.rotation.x = Math.PI / 2;</p>
<p class="p1"><span class="Apple-converted-space">            </span>frosting.position.y = 2.5; // Top of main layer</p>
<p class="p1"><span class="Apple-converted-space">            </span>frosting.castShadow = true;</p>
<p class="p1"><span class="Apple-converted-space">            </span>cakeGroup.add(frosting);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const topLayerMat = new THREE.MeshPhongMaterial({ color: 0xffb6c1, shininess: 60 }); // LightPink</p>
<p class="p1"><span class="Apple-converted-space">            </span>const topLayerGeo = new THREE.CylinderGeometry(2.5, 3, 2, 32);</p>
<p class="p1"><span class="Apple-converted-space">            </span>const topLayer = new THREE.Mesh(topLayerGeo, topLayerMat);</p>
<p class="p1"><span class="Apple-converted-space">            </span>topLayer.castShadow = true;</p>
<p class="p1"><span class="Apple-converted-space">            </span>topLayer.receiveShadow = true;</p>
<p class="p1"><span class="Apple-converted-space">            </span>topLayer.position.y = mainLayer.position.y + 2.5 / 2 + 2 / 2 + 0.2; // Stacked</p>
<p class="p1"><span class="Apple-converted-space">            </span>cakeGroup.add(topLayer);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>cake = cakeGroup;</p>
<p class="p1"><span class="Apple-converted-space">            </span>scene.add(cake);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Cheeky jiggle for the cake</p>
<p class="p1"><span class="Apple-converted-space">            </span>anime({</p>
<p class="p1"><span class="Apple-converted-space">                </span>targets: cake.rotation,</p>
<p class="p1"><span class="Apple-converted-space">                </span>y: [</p>
<p class="p1"><span class="Apple-converted-space">                    </span>{ value: '-=0.05', duration: 1800, easing: 'easeInOutSine' },</p>
<p class="p1"><span class="Apple-converted-space">                    </span>{ value: '+=0.1', duration: 2200, easing: 'easeInOutSine' },</p>
<p class="p1"><span class="Apple-converted-space">                    </span>{ value: '-=0.05', duration: 2000, easing: 'easeInOutSine' },</p>
<p class="p1"><span class="Apple-converted-space">                </span>],</p>
<p class="p1"><span class="Apple-converted-space">                </span>loop: true,</p>
<p class="p1"><span class="Apple-converted-space">                </span>direction: 'alternate'</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">             </span>anime({</p>
<p class="p1"><span class="Apple-converted-space">                </span>targets: cake.position,</p>
<p class="p1"><span class="Apple-converted-space">                </span>y: [</p>
<p class="p1"><span class="Apple-converted-space">                    </span>{ value: '+=0.1', duration: 1500, easing: 'easeInOutQuad' },</p>
<p class="p1"><span class="Apple-converted-space">                    </span>{ value: '-=0.1', duration: 1500, easing: 'easeInOutQuad' },</p>
<p class="p1"><span class="Apple-converted-space">                </span>],</p>
<p class="p1"><span class="Apple-converted-space">                </span>loop: true,</p>
<p class="p1"><span class="Apple-converted-space">                </span>direction: 'alternate',</p>
<p class="p1"><span class="Apple-converted-space">                </span>delay: 500</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function createCandlesOnCake(numCandles) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const cakeTopY = cake.children[2].position.y + cake.children[2].geometry.parameters.height / 2; // Top of the smaller cylinder</p>
<p class="p1"><span class="Apple-converted-space">            </span>const cakeTopRadius = cake.children[2].geometry.parameters.radiusTop * 0.7; // Place them inwards a bit</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>for (let i = 0; i &lt; numCandles; i++) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const angle = (i / numCandles) * Math.PI * 2;</p>
<p class="p1"><span class="Apple-converted-space">                </span>const x = Math.cos(angle) * cakeTopRadius;</p>
<p class="p1"><span class="Apple-converted-space">                </span>const z = Math.sin(angle) * cakeTopRadius;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>// Candle body</p>
<p class="p1"><span class="Apple-converted-space">                </span>const candleHeight = 1.5;</p>
<p class="p1"><span class="Apple-converted-space">                </span>const candleRadius = 0.15;</p>
<p class="p1"><span class="Apple-converted-space">                </span>const candleGeo = new THREE.CylinderGeometry(candleRadius, candleRadius * 0.8, candleHeight, 12); // Slightly tapered</p>
<p class="p1"><span class="Apple-converted-space">                </span>const candleMat = new THREE.MeshPhongMaterial({ color: randomCheekyColor(), shininess: 30 });</p>
<p class="p1"><span class="Apple-converted-space">                </span>const candle = new THREE.Mesh(candleGeo, candleMat);</p>
<p class="p1"><span class="Apple-converted-space">                </span>candle.castShadow = true;</p>
<p class="p1"><span class="Apple-converted-space">                </span>candle.position.set(x, cakeTopY + candleHeight / 2, z);</p>
<p class="p1"><span class="Apple-converted-space">                </span>candle.rotation.y = Math.random() * Math.PI; // Jaunty angle</p>
<p class="p1"><span class="Apple-converted-space">                </span>candles.push({ mesh: candle, lit: true, id: `candle-${i}` });</p>
<p class="p1"><span class="Apple-converted-space">                </span>cake.add(candle); // Add to cake group so they move with it</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>// Flame (using a small sphere with emissive material)</p>
<p class="p1"><span class="Apple-converted-space">                </span>const flameGeo = new THREE.SphereGeometry(candleRadius * 1.1, 16, 16); // A bit larger than candle radius</p>
<p class="p1"><span class="Apple-converted-space">                </span>const flameMat = new THREE.MeshBasicMaterial({ color: 0xffaa33, transparent: true, opacity: 0.9 });</p>
<p class="p1"><span class="Apple-converted-space">                </span>const flame = new THREE.Mesh(flameGeo, flameMat);</p>
<p class="p1"><span class="Apple-converted-space">                </span>flame.position.set(x, cakeTopY + candleHeight + candleRadius * 0.6, z); // Position flame on top of candle</p>
<p class="p1"><span class="Apple-converted-space">                </span>flames.push(flame);</p>
<p class="p1"><span class="Apple-converted-space">                </span>cake.add(flame); // Add to cake group</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>// Anime.js for flame flicker</p>
<p class="p1"><span class="Apple-converted-space">                </span>anime({</p>
<p class="p1"><span class="Apple-converted-space">                    </span>targets: flame.scale,</p>
<p class="p1"><span class="Apple-converted-space">                    </span>x: [0.8, 1.2, 0.7, 1.3, 1],</p>
<p class="p1"><span class="Apple-converted-space">                    </span>y: [1.2, 0.8, 1.3, 0.7, 1],</p>
<p class="p1"><span class="Apple-converted-space">                    </span>duration: () =&gt; anime.random(300, 600),</p>
<p class="p1"><span class="Apple-converted-space">                    </span>loop: true,</p>
<p class="p1"><span class="Apple-converted-space">                    </span>direction: 'alternate',</p>
<p class="p1"><span class="Apple-converted-space">                    </span>easing: 'easeInOutSine'</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p1"><span class="Apple-converted-space">                </span>anime({</p>
<p class="p1"><span class="Apple-converted-space">                    </span>targets: flame.material,</p>
<p class="p1"><span class="Apple-converted-space">                    </span>opacity: [0.7, 0.95, 0.6, 1, 0.8],</p>
<p class="p1"><span class="Apple-converted-space">                    </span>duration: () =&gt; anime.random(250, 500),</p>
<p class="p1"><span class="Apple-converted-space">                    </span>loop: true,</p>
<p class="p1"><span class="Apple-converted-space">                    </span>direction: 'alternate',</p>
<p class="p1"><span class="Apple-converted-space">                    </span>easing: 'linear'</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function handleBlowOutCandles() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!allCandlesLit) {</p>
<p class="p1"><span class="Apple-converted-space">                 </span>// Relight candles with a cheeky message</p>
<p class="p1"><span class="Apple-converted-space">                </span>mainTitle.textContent = "✨ Poof! They're back! ✨";</p>
<p class="p1"><span class="Apple-converted-space">                </span>flames.forEach((flame, index) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>candles[index].lit = true;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>flame.visible = true;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>anime({</p>
<p class="p1"><span class="Apple-converted-space">                        </span>targets: flame.scale,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>x: 1, y: 1, z: 1,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>duration: 500,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>delay: index * 100,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>easing: 'easeOutElastic'</p>
<p class="p1"><span class="Apple-converted-space">                    </span>});</p>
<p class="p1"><span class="Apple-converted-space">                    </span>anime({</p>
<p class="p1"><span class="Apple-converted-space">                        </span>targets: flame.material,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>opacity: 0.9,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>duration: 500,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>delay: index * 100,</p>
<p class="p1"><span class="Apple-converted-space">                    </span>});</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p1"><span class="Apple-converted-space">                </span>allCandlesLit = true;</p>
<p class="p1"><span class="Apple-converted-space">                </span>blowCandlesButton.textContent = "🌬️ Blow Out Candles!";</p>
<p class="p1"><span class="Apple-converted-space">                </span>setTimeout(() =&gt; mainTitle.textContent = "🎉 Happy Birthday, Polly! 🎉", 2000);</p>
<p class="p1"><span class="Apple-converted-space">                </span>return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>allCandlesLit = false;</p>
<p class="p1"><span class="Apple-converted-space">            </span>mainTitle.textContent = "🎂 Make a Wish, Polly! 🎂";</p>
<p class="p1"><span class="Apple-converted-space">            </span>flames.forEach((flame, index) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (candles[index].lit) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>candles[index].lit = false;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>anime({</p>
<p class="p1"><span class="Apple-converted-space">                        </span>targets: flame.scale,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>x: 0, y: 0, z: 0,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>duration: 300,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>delay: index * 80,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>easing: 'easeInQuad',</p>
<p class="p1"><span class="Apple-converted-space">                        </span>complete: () =&gt; flame.visible = false</p>
<p class="p1"><span class="Apple-converted-space">                    </span>});</p>
<p class="p1"><span class="Apple-converted-space">                     </span>anime({</p>
<p class="p1"><span class="Apple-converted-space">                        </span>targets: flame.material,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>opacity: 0,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>duration: 300,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>delay: index * 80,</p>
<p class="p1"><span class="Apple-converted-space">                    </span>});</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">            </span>blowCandlesButton.textContent = "🕯️ Relight Candles?";</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Cheeky sound effect (conceptual)</p>
<p class="p1"><span class="Apple-converted-space">            </span>// playSound('poof.mp3');</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Trigger confetti or a small celebration</p>
<p class="p1"><span class="Apple-converted-space">            </span>setTimeout(launchCelebrationConfetti, 500);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function launchCelebrationConfetti() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>// Use Anime.js to create some DOM-based confetti for simplicity here</p>
<p class="p1"><span class="Apple-converted-space">            </span>for (let i = 0; i &lt; 50; i++) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const confettiPiece = document.createElement('div');</p>
<p class="p1"><span class="Apple-converted-space">                </span>confettiPiece.style.position = 'absolute';</p>
<p class="p1"><span class="Apple-converted-space">                </span>confettiPiece.style.width = anime.random(5, 15) + 'px';</p>
<p class="p1"><span class="Apple-converted-space">                </span>confettiPiece.style.height = anime.random(8, 20) + 'px';</p>
<p class="p1"><span class="Apple-converted-space">                </span>confettiPiece.style.backgroundColor = `hsl(${anime.random(0, 360)}, 100%, 70%)`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>confettiPiece.style.left = anime.random(0, 100) + '%';</p>
<p class="p1"><span class="Apple-converted-space">                </span>confettiPiece.style.top = '-20px'; // Start above screen</p>
<p class="p1"><span class="Apple-converted-space">                </span>confettiPiece.style.transform = `rotate(${anime.random(-180, 180)}deg)`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>sceneContainer.appendChild(confettiPiece); // Add to scene container to overlay</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>anime({</p>
<p class="p1"><span class="Apple-converted-space">                    </span>targets: confettiPiece,</p>
<p class="p1"><span class="Apple-converted-space">                    </span>top: '110%', // Fall to bottom</p>
<p class="p1"><span class="Apple-converted-space">                    </span>translateX: () =&gt; anime.random(-100, 100) + 'px', // Sideways drift</p>
<p class="p1"><span class="Apple-converted-space">                    </span>rotate: () =&gt; anime.random(360, 720) + 'deg',</p>
<p class="p1"><span class="Apple-converted-space">                    </span>opacity: [1, 0],</p>
<p class="p1"><span class="Apple-converted-space">                    </span>duration: anime.random(2000, 4000),</p>
<p class="p1"><span class="Apple-converted-space">                    </span>easing: 'easeInSine',</p>
<p class="p1"><span class="Apple-converted-space">                    </span>delay: anime.random(0, 300),</p>
<p class="p1"><span class="Apple-converted-space">                    </span>complete: () =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>confettiPiece.remove();</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// --- Fireworks (Three.js Particles) ---</p>
<p class="p1"><span class="Apple-converted-space">        </span>function launchSingleFirework() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const numParticles = anime.random(80, 150);</p>
<p class="p1"><span class="Apple-converted-space">            </span>const fireworkColor = new THREE.Color(randomCheekyColor());</p>
<p class="p1"><span class="Apple-converted-space">            </span>const particleMaterial = new THREE.PointsMaterial({</p>
<p class="p1"><span class="Apple-converted-space">                </span>color: fireworkColor,</p>
<p class="p1"><span class="Apple-converted-space">                </span>size: 0.3,</p>
<p class="p1"><span class="Apple-converted-space">                </span>transparent: true,</p>
<p class="p1"><span class="Apple-converted-space">                </span>opacity: 0.9,</p>
<p class="p1"><span class="Apple-converted-space">                </span>blending: THREE.AdditiveBlending, // For a nice bright effect</p>
<p class="p1"><span class="Apple-converted-space">                </span>depthWrite: false // Particles don't obscure each other as much</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const particlesGeometry = new THREE.BufferGeometry();</p>
<p class="p1"><span class="Apple-converted-space">            </span>const positions = [];</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Starting point of the firework (rocket phase)</p>
<p class="p1"><span class="Apple-converted-space">            </span>const startX = anime.random(-5, 5);</p>
<p class="p1"><span class="Apple-converted-space">            </span>const startY = 0;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const startZ = anime.random(-5, 5);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const rocketGeo = new THREE.SphereGeometry(0.2, 8, 8);</p>
<p class="p1"><span class="Apple-converted-space">            </span>const rocketMat = new THREE.MeshBasicMaterial({ color: fireworkColor, emissive: fireworkColor, emissiveIntensity: 2});</p>
<p class="p1"><span class="Apple-converted-space">            </span>const rocket = new THREE.Mesh(rocketGeo, rocketMat);</p>
<p class="p1"><span class="Apple-converted-space">            </span>rocket.position.set(startX, startY, startZ);</p>
<p class="p1"><span class="Apple-converted-space">            </span>scene.add(rocket);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>const targetY = anime.random(12, 20); // Explosion height</p>
<p class="p1"><span class="Apple-converted-space">            </span>const targetX = startX + anime.random(-3, 3);</p>
<p class="p1"><span class="Apple-converted-space">            </span>const targetZ = startZ + anime.random(-3, 3);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Animate rocket ascent with Anime.js</p>
<p class="p1"><span class="Apple-converted-space">            </span>anime({</p>
<p class="p1"><span class="Apple-converted-space">                </span>targets: rocket.position,</p>
<p class="p1"><span class="Apple-converted-space">                </span>x: targetX,</p>
<p class="p1"><span class="Apple-converted-space">                </span>y: targetY,</p>
<p class="p1"><span class="Apple-converted-space">                </span>z: targetZ,</p>
<p class="p1"><span class="Apple-converted-space">                </span>duration: anime.random(800, 1500),</p>
<p class="p1"><span class="Apple-converted-space">                </span>easing: 'easeOutQuad',</p>
<p class="p1"><span class="Apple-converted-space">                </span>update: function(anim) { // Create a trail</p>
<p class="p1"><span class="Apple-converted-space">                    </span>if(Math.random() &lt; 0.3) { // Don't add too many trail particles</p>
<p class="p1"><span class="Apple-converted-space">                        </span>const trailParticleGeo = new THREE.SphereGeometry(0.05, 4, 4);</p>
<p class="p1"><span class="Apple-converted-space">                        </span>const trailParticleMat = new THREE.MeshBasicMaterial({color: fireworkColor, transparent: true, opacity: 0.7});</p>
<p class="p1"><span class="Apple-converted-space">                        </span>const trailParticle = new THREE.Mesh(trailParticleGeo, trailParticleMat);</p>
<p class="p1"><span class="Apple-converted-space">                        </span>trailParticle.position.copy(rocket.position);</p>
<p class="p1"><span class="Apple-converted-space">                        </span>scene.add(trailParticle);</p>
<p class="p1"><span class="Apple-converted-space">                        </span>anime({</p>
<p class="p1"><span class="Apple-converted-space">                            </span>targets: trailParticle.scale,</p>
<p class="p1"><span class="Apple-converted-space">                            </span>x:0, y:0, z:0,</p>
<p class="p1"><span class="Apple-converted-space">                            </span>duration: anime.random(500,1000),</p>
<p class="p1"><span class="Apple-converted-space">                            </span>easing: 'linear',</p>
<p class="p1"><span class="Apple-converted-space">                            </span>complete: () =&gt; scene.remove(trailParticle)</p>
<p class="p1"><span class="Apple-converted-space">                        </span>});</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>},</p>
<p class="p1"><span class="Apple-converted-space">                </span>complete: () =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>scene.remove(rocket); // Rocket disappears</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                    </span>// Explosion</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const explosionParticles = [];</p>
<p class="p1"><span class="Apple-converted-space">                    </span>for (let i = 0; i &lt; numParticles; i++) {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>positions.push(targetX, targetY, targetZ); // All start at explosion center</p>
<p class="p1"><span class="Apple-converted-space">                        </span>explosionParticles.push({</p>
<p class="p1"><span class="Apple-converted-space">                            </span>velocity: new THREE.Vector3(</p>
<p class="p1"><span class="Apple-converted-space">                                </span>(Math.random() - 0.5) * 0.5,</p>
<p class="p1"><span class="Apple-converted-space">                                </span>(Math.random() - 0.5) * 0.5,</p>
<p class="p1"><span class="Apple-converted-space">                                </span>(Math.random() - 0.5) * 0.5</p>
<p class="p1"><span class="Apple-converted-space">                            </span>),</p>
<p class="p1"><span class="Apple-converted-space">                            </span>life: anime.random(80, 120) // Frames</p>
<p class="p1"><span class="Apple-converted-space">                        </span>});</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>particlesGeometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const particleSystem = new THREE.Points(particlesGeometry, particleMaterial);</p>
<p class="p1"><span class="Apple-converted-space">                    </span>scene.add(particleSystem);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                    </span>// Animate particles exploding outwards using Anime.js on the buffer attribute</p>
<p class="p1"><span class="Apple-converted-space">                    </span>// This is a bit more complex; simpler is to animate individual small meshes if performance allows</p>
<p class="p1"><span class="Apple-converted-space">                    </span>// For a Points system, you'd update the 'position' attribute in the animation loop</p>
<p class="p1"><span class="Apple-converted-space">                    </span>// Here's a conceptual animation of the system itself fading:</p>
<p class="p1"><span class="Apple-converted-space">                    </span>anime({</p>
<p class="p1"><span class="Apple-converted-space">                        </span>targets: particleMaterial,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>opacity: 0,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>size: 0.01,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>duration: anime.random(1000, 2000),</p>
<p class="p1"><span class="Apple-converted-space">                        </span>easing: 'easeInExpo',</p>
<p class="p1"><span class="Apple-converted-space">                        </span>delay: 200, // Let them expand a bit first</p>
<p class="p1"><span class="Apple-converted-space">                        </span>complete: () =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>scene.remove(particleSystem);</p>
<p class="p1"><span class="Apple-converted-space">                            </span>particlesGeometry.dispose();</p>
<p class="p1"><span class="Apple-converted-space">                            </span>particleMaterial.dispose();</p>
<p class="p1"><span class="Apple-converted-space">                        </span>}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                    </span>// Animate individual particle movements (if not using the optimized Points attribute update)</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const currentPositions = particleSystem.geometry.attributes.position;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>anime({</p>
<p class="p1"><span class="Apple-converted-space">                        </span>duration: anime.random(1200, 1800),</p>
<p class="p1"><span class="Apple-converted-space">                        </span>easing: 'easeOutExpo',</p>
<p class="p1"><span class="Apple-converted-space">                        </span>update: function () {</p>
<p class="p1"><span class="Apple-converted-space">                            </span>for (let i = 0; i &lt; numParticles; i++) {</p>
<p class="p1"><span class="Apple-converted-space">                                </span>currentPositions.array[i * 3] += explosionParticles[i].velocity.x; <span class="Apple-converted-space">    </span>// x</p>
<p class="p1"><span class="Apple-converted-space">                                </span>currentPositions.array[i * 3 + 1] += explosionParticles[i].velocity.y; // y</p>
<p class="p1"><span class="Apple-converted-space">                                </span>currentPositions.array[i * 3 + 2] += explosionParticles[i].velocity.z; // z</p>
<p class="p1"><span class="Apple-converted-space">                                </span>explosionParticles[i].velocity.y -= 0.003; // Gravity</p>
<p class="p1"><span class="Apple-converted-space">                            </span>}</p>
<p class="p1"><span class="Apple-converted-space">                            </span>currentPositions.needsUpdate = true;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>}</p>
<p class="p1"><span class="Apple-converted-space">                    </span>});</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">            </span>mainTitle.textContent = "✨ KA-POW! ✨";</p>
<p class="p1"><span class="Apple-converted-space">            </span>setTimeout(() =&gt; mainTitle.textContent = "🎉 Happy Birthday, Polly! 🎉", 1500);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// --- Matter.js Setup (Cheeky Presents) ---</p>
<p class="p1"><span class="Apple-converted-space">        </span>function initMatterJS() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>matterEngine = Matter.Engine.create();</p>
<p class="p1"><span class="Apple-converted-space">            </span>matterWorld = matterEngine.world;</p>
<p class="p1"><span class="Apple-converted-space">            </span>matterEngine.world.gravity.y = 0.3; // Softer gravity for a floaty feel</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Optional: Visual renderer for Matter.js (good for debugging)</p>
<p class="p1"><span class="Apple-converted-space">            </span>/*</p>
<p class="p1"><span class="Apple-converted-space">            </span>matterRenderer = Matter.Render.create({</p>
<p class="p1"><span class="Apple-converted-space">                </span>element: matterContainer, // Render inside the matter-container div</p>
<p class="p1"><span class="Apple-converted-space">                </span>engine: matterEngine,</p>
<p class="p1"><span class="Apple-converted-space">                </span>options: {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>width: sceneContainer.clientWidth,</p>
<p class="p1"><span class="Apple-converted-space">                    </span>height: sceneContainer.clientHeight,</p>
<p class="p1"><span class="Apple-converted-space">                    </span>wireframes: true, // Show outlines</p>
<p class="p1"><span class="Apple-converted-space">                    </span>background: 'transparent' // Transparent so Three.js scene shows</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">            </span>Matter.Render.run(matterRenderer);</p>
<p class="p1"><span class="Apple-converted-space">            </span>*/</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Add boundaries (invisible walls for presents)</p>
<p class="p1"><span class="Apple-converted-space">            </span>const wallThickness = 100;</p>
<p class="p1"><span class="Apple-converted-space">            </span>Matter.World.add(matterWorld, [</p>
<p class="p1"><span class="Apple-converted-space">                </span>Matter.Bodies.rectangle(sceneContainer.clientWidth / 2, -wallThickness / 2, sceneContainer.clientWidth, wallThickness, { isStatic: true }), // Top</p>
<p class="p1"><span class="Apple-converted-space">                </span>Matter.Bodies.rectangle(sceneContainer.clientWidth / 2, sceneContainer.clientHeight + wallThickness / 2, sceneContainer.clientWidth, wallThickness, { isStatic: true }), // Bottom</p>
<p class="p1"><span class="Apple-converted-space">                </span>Matter.Bodies.rectangle(-wallThickness / 2, sceneContainer.clientHeight / 2, wallThickness, sceneContainer.clientHeight, { isStatic: true }), // Left</p>
<p class="p1"><span class="Apple-converted-space">                </span>Matter.Bodies.rectangle(sceneContainer.clientWidth + wallThickness / 2, sceneContainer.clientHeight / 2, wallThickness, sceneContainer.clientHeight, { isStatic: true })<span class="Apple-converted-space">  </span>// Right</p>
<p class="p1"><span class="Apple-converted-space">            </span>]);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Create some "presents" (DOM elements controlled by Matter.js)</p>
<p class="p1"><span class="Apple-converted-space">            </span>const presentTexts = ["A Giggle!", "Sparkles!", "Joy!", "A Pony*", "*Virtual Pony"];</p>
<p class="p1"><span class="Apple-converted-space">            </span>for (let i = 0; i &lt; 4; i++) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>const size = anime.random(50, 80);</p>
<p class="p1"><span class="Apple-converted-space">                </span>const x = anime.random(size, sceneContainer.clientWidth - size);</p>
<p class="p1"><span class="Apple-converted-space">                </span>const y = anime.random(-150, -50); // Start above the screen</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>// Create DOM element for the present</p>
<p class="p1"><span class="Apple-converted-space">                </span>const presentDiv = document.createElement('div');</p>
<p class="p1"><span class="Apple-converted-space">                </span>presentDiv.classList.add('matter-object');</p>
<p class="p1"><span class="Apple-converted-space">                </span>presentDiv.style.width = size + 'px';</p>
<p class="p1"><span class="Apple-converted-space">                </span>presentDiv.style.height = size + 'px';</p>
<p class="p1"><span class="Apple-converted-space">                </span>presentDiv.style.backgroundColor = `hsl(${anime.random(180, 300)}, 70%, 60%)`; // Purples, blues</p>
<p class="p1"><span class="Apple-converted-space">                </span>presentDiv.innerHTML = `🎁&lt;br&gt;${presentTexts[i%presentTexts.length]}`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>matterContainer.appendChild(presentDiv); // Add to its own container</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>// Create Matter.js body</p>
<p class="p1"><span class="Apple-converted-space">                </span>const presentBody = Matter.Bodies.rectangle(x, y, size, size, {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>restitution: 0.6, // Bounciness</p>
<p class="p1"><span class="Apple-converted-space">                    </span>friction: 0.05,</p>
<p class="p1"><span class="Apple-converted-space">                    </span>angle: Math.random() * Math.PI,</p>
<p class="p1"><span class="Apple-converted-space">                    </span>render: { /* fillStyle: 'transparent', strokeStyle: 'transparent' */ } // Make default Matter render invisible if using DOM elements</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>interactiveObjects.push({ div: presentDiv, body: presentBody });</p>
<p class="p1"><span class="Apple-converted-space">                </span>Matter.World.add(matterWorld, presentBody);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>// Make presents draggable (requires Matter.MouseConstraint)</p>
<p class="p1"><span class="Apple-converted-space">                </span>presentDiv.addEventListener('mousedown', (e) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                     </span>// Simple pop animation on click</p>
<p class="p1"><span class="Apple-converted-space">                    </span>anime({</p>
<p class="p1"><span class="Apple-converted-space">                        </span>targets: presentDiv,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>scale: [1, 1.3, 1],</p>
<p class="p1"><span class="Apple-converted-space">                        </span>rotate: '+=15deg',</p>
<p class="p1"><span class="Apple-converted-space">                        </span>duration: 300,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>easing: 'easeOutElastic'</p>
<p class="p1"><span class="Apple-converted-space">                    </span>});</p>
<p class="p1"><span class="Apple-converted-space">                    </span>mainTitle.textContent = `${presentTexts[i%presentTexts.length]} for Polly!`;</p>
<p class="p1"><span class="Apple-converted-space">                     </span>setTimeout(() =&gt; mainTitle.textContent = "🎉 Happy Birthday, Polly! 🎉", 2000);</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Add mouse control for dragging Matter.js objects</p>
<p class="p1"><span class="Apple-converted-space">            </span>const mouse = Matter.Mouse.create(sceneContainer); // Use sceneContainer for mouse events for Matter</p>
<p class="p1"><span class="Apple-converted-space">            </span>const mouseConstraint = Matter.MouseConstraint.create(matterEngine, {</p>
<p class="p1"><span class="Apple-converted-space">                </span>mouse: mouse,</p>
<p class="p1"><span class="Apple-converted-space">                </span>constraint: {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>stiffness: 0.1,</p>
<p class="p1"><span class="Apple-converted-space">                    </span>render: { visible: false } // Don't render the constraint line</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">            </span>Matter.World.add(matterWorld, mouseConstraint);</p>
<p class="p1"><span class="Apple-converted-space">             </span>// Allow clicks to pass through matter container to threejs if not on a matter object</p>
<p class="p1"><span class="Apple-converted-space">            </span>matterContainer.style.pointerEvents = 'none';</p>
<p class="p1"><span class="Apple-converted-space">            </span>interactiveObjects.forEach(obj =&gt; obj.div.style.pointerEvents = 'auto');</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>Matter.Engine.run(matterEngine);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// --- Animation Loop ---</p>
<p class="p1"><span class="Apple-converted-space">        </span>function animate() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>requestAnimationFrame(animate);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Update Matter.js DOM elements to match physics bodies</p>
<p class="p1"><span class="Apple-converted-space">            </span>interactiveObjects.forEach(obj =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>obj.div.style.left = (obj.body.position.x - obj.div.offsetWidth / 2) + 'px';</p>
<p class="p1"><span class="Apple-converted-space">                </span>obj.div.style.top = (obj.body.position.y - obj.div.offsetHeight / 2) + 'px';</p>
<p class="p1"><span class="Apple-converted-space">                </span>obj.div.style.transform = `rotate(${obj.body.angle}rad)`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>renderer.render(scene, camera);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// --- Event Listeners ---</p>
<p class="p1"><span class="Apple-converted-space">        </span>blowCandlesButton.addEventListener('click', handleBlowOutCandles);</p>
<p class="p1"><span class="Apple-converted-space">        </span>launchFireworksButton.addEventListener('click', launchSingleFirework);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>window.addEventListener('resize', () =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">            </span>camera.aspect = sceneContainer.clientWidth / sceneContainer.clientHeight;</p>
<p class="p1"><span class="Apple-converted-space">            </span>camera.updateProjectionMatrix();</p>
<p class="p1"><span class="Apple-converted-space">            </span>renderer.setSize(sceneContainer.clientWidth, sceneContainer.clientHeight);</p>
<p class="p1"><span class="Apple-converted-space">            </span>// If using Matter.js renderer, also resize it:</p>
<p class="p1"><span class="Apple-converted-space">            </span>/*</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (matterRenderer) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>matterRenderer.canvas.width = sceneContainer.clientWidth;</p>
<p class="p1"><span class="Apple-converted-space">                </span>matterRenderer.canvas.height = sceneContainer.clientHeight;</p>
<p class="p1"><span class="Apple-converted-space">                </span>Matter.Render.lookAt(matterRenderer, { // Recenter view</p>
<p class="p1"><span class="Apple-converted-space">                    </span>min: { x: 0, y: 0 },</p>
<p class="p1"><span class="Apple-converted-space">                    </span>max: { x: sceneContainer.clientWidth, y: sceneContainer.clientHeight }</p>
<p class="p1"><span class="Apple-converted-space">                </span>});</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>*/</p>
<p class="p1"><span class="Apple-converted-space">        </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// --- Initial Cheeky Title Animation ---</p>
<p class="p1"><span class="Apple-converted-space">        </span>function initialAnimations() {</p>
<p class="p1"><span class="Apple-converted-space">            </span>anime({</p>
<p class="p1"><span class="Apple-converted-space">                </span>targets: mainTitle,</p>
<p class="p1"><span class="Apple-converted-space">                </span>translateY: [-50, 0],</p>
<p class="p1"><span class="Apple-converted-space">                </span>opacity: [0, 1],</p>
<p class="p1"><span class="Apple-converted-space">                </span>rotate: ['-5deg', '0deg', '3deg', '0deg'],</p>
<p class="p1"><span class="Apple-converted-space">                </span>scale: [0.8, 1],</p>
<p class="p1"><span class="Apple-converted-space">                </span>duration: 1500,</p>
<p class="p1"><span class="Apple-converted-space">                </span>delay: 300,</p>
<p class="p1"><span class="Apple-converted-space">                </span>elasticity: 400</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>anime({</p>
<p class="p1"><span class="Apple-converted-space">                </span>targets: '.interactive-button',</p>
<p class="p1"><span class="Apple-converted-space">                </span>translateY: [50, 0],</p>
<p class="p1"><span class="Apple-converted-space">                </span>opacity: [0, 1],</p>
<p class="p1"><span class="Apple-converted-space">                </span>scale: [0.7, 1],</p>
<p class="p1"><span class="Apple-converted-space">                </span>duration: 1200,</p>
<p class="p1"><span class="Apple-converted-space">                </span>delay: anime.stagger(200, {start: 800}),</p>
<p class="p1"><span class="Apple-converted-space">                </span>easing: 'easeOutElastic(1, .7)'</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// --- Initialize Everything ---</p>
<p class="p1"><span class="Apple-converted-space">        </span>initThreeJS();</p>
<p class="p1"><span class="Apple-converted-space">        </span>initMatterJS(); // Initialize Matter.js for presents</p>
<p class="p1"><span class="Apple-converted-space">        </span>initialAnimations();</p>
<p class="p1"><span class="Apple-converted-space">        </span>animate();</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Add a little cheeky message to the console for fun</p>
<p class="p1"><span class="Apple-converted-space">        </span>console.log("Psst, Polly! Hope your birthday is as fantastic as this virtual world! 🥳 - From your friend!");</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/script&gt;</p>
<p class="p1">&lt;/body&gt;</p>
<p class="p1">&lt;/html&gt;</p>
</body>
</html>
